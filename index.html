<!DOCTYPE html>
<html>
<head>
    <title>日月地轨道展示</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="index.css">
    <script type="importmap">
        {
            "imports": {
                "three": "./node_modules/three/build/three.module.js",
                "three/addons/": "./node_modules/three/examples/jsm/"
            }
        }
    </script>
</head>

<body>
    <select id="view_method">
        <option value="front_view">俯视图</option>
        <option value="side_view">侧视图</option>
        <option value="3D">3D</option>
    </select>
    <select id="earth_skin">
        <option value="satellit_imagery">卫星图</option>
        <option value="map">地图</option>
    </select>
    <label id="solar_eclipse_label">日食</label>
    <ul id="solar_eclipse">
        <img src="./images/日全食.png">
        <img src="./images/日偏食.png">
        <img src="./images/日环食.png">
    </ul>
    <label id="moon_eclipse_label">月食</label>
    <ul id="moon_eclipse">
        <img src="./images/月全食.png">
        <img src="./images/月偏食.png">
        <img src="./images/月环食.png">
    </ul>
    <div id="main_canvas">
        <script type="module">
            import * as THREE from 'three';
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
            const SUN_TIME = 24.47;
            const EARTH_TIME = 1;
            const MOON_TIME = 27.32;
    
            const SUN_ANGLE = 7.25;
            const EARTH_ANGLE = 23.26;
            const MOON_ANGLE = 1.54;
            const MOON_ORBIT_ANGLE = 5.09;
    
            const EARTH_ORBIT_TIME = 365;
            const MOON_ORBIT_TIME = 27.32;
    
            const PERIHELION_DISTANCE = 14709;
            const APHELION_DISTANCE = 15210;
    
            const HALF_LONG_AXIS = 14960;
            const HALF_SHORT_AXIS = 14958;
    
            const PERIGEE_DISTANCE = 2896;
            const APOGEE_DISTANCE = 3248;
    
            const HALF_LONG_AXIS_OF_MOON = 3072;
            const HALF_SHORT_AXIS_OF_MOON = 3064;
    
            const scene = new THREE.Scene();//初始化场景
            const main_camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1 ,10000);//初始化主摄像机
            const camera_at_sun = new THREE.PerspectiveCamera(20, window.innerWidth / window.innerHeight, 8, 1000);//初始化聚焦太阳的摄像机
            const camera_at_moon = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 8, 1000);//初始化聚焦月球的摄像机
            main_camera.position.z = 1200;//设置主摄像机位置
            const renderer = new THREE.WebGLRenderer({antialias: true});//初始化渲染器，开启抗锯齿
            renderer.shadowMap.enabled = true;//开启阴影
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.autoClear = false;
            renderer.setClearColor(0xffffff)
            const orbitControls = new OrbitControls(main_camera, renderer.domElement);//初始化摄像机轨道控制
            document.getElementById('main_canvas').appendChild(renderer.domElement);
            const loader = new THREE.TextureLoader();//初始化加载器
    
            const ambient_light = new THREE.AmbientLight('white', 0.1);//设置环境光
            scene.add(ambient_light);
    
            const point_light = new THREE.PointLight('white');//设置从太阳发出的点光源
            point_light.intensity = 3;
            point_light.position.set(0, 0, 0);
            point_light.castShadow = true;
            point_light.shadow.mapSize.width = 2048;
            point_light.shadow.mapSize.height = 2048;
            scene.add(point_light);
            
            //// 加载图像作为背景
            const backgroundImage = loader.load('./images/galaxy.jpg');
            scene.background = backgroundImage;
    
            //创建球体函数
            function createSphereGeometry(options){
                const geometry = new THREE.SphereGeometry(options.radius);
                const sphere = new THREE.Mesh(geometry, options.material);
                sphere.position.add(new THREE.Vector3(...options.position));
                return sphere;
            };
    
            // 加载太阳背景图像
            const sun_background_texture = loader.load('./images/sun.jpeg');
            const sun_material = new THREE.MeshBasicMaterial({ map: sun_background_texture });
    
            //创建太阳
            const sun = createSphereGeometry({
                radius: 20,
                material: sun_material,
                position: [0, 0, 0]
            });
    
            // 加载地球卫星图背景图像
            const earth_background_texture = loader.load('./images/earth.jpg'); 
            const earth_material = new THREE.MeshStandardMaterial({ map: earth_background_texture });

            //加载地球地图背景图像
            const earth_map_background_texture = loader.load('./images/earth_map.jfif');
            const earth_map_material = new THREE.MeshStandardMaterial({ map: earth_map_background_texture});
    
            //创建地球
            const earth = createSphereGeometry({
                radius: 8,
                material: earth_material,
                position: [300, 0, 0]
            });

            earth.castShadow = true;
            earth.receiveShadow = true;
    
            // 加载月球背景图像
            const moon_background_texture = loader.load('./images/moon.jpg'); 
            const moon_material = new THREE.MeshStandardMaterial({ map: moon_background_texture });
    
            //创建月球
            const moon = createSphereGeometry({
                radius: 4,
                material: moon_material,
                position: [364, 0, 0]
            });

            moon.castShadow = true;
            moon.receiveShadow = true;
    
            scene.add(sun);
            scene.add(earth);
            scene.add(moon);
    
            //创建曲线函数
            function createCurveGeometry(options){
                const points = options.orbit.getPoints(100);
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({color: options.color});
                const curve = new THREE.Line(geometry, material);
                curve.position.add(new THREE.Vector3(...options.position));
                return curve;
            }
    
            //地球轨道
            const earth_orbit = new THREE.EllipseCurve(
                300*(1 - HALF_LONG_AXIS / APHELION_DISTANCE),
                0,
                300 * HALF_LONG_AXIS / APHELION_DISTANCE,
                300 * HALF_SHORT_AXIS / APHELION_DISTANCE,
                0,
                2 * Math.PI,
                false,
                0
            );
    
            //2d月球轨道
            const moon_orbit_2d = new THREE.EllipseCurve(
                300*(APOGEE_DISTANCE / APHELION_DISTANCE - HALF_LONG_AXIS_OF_MOON / APHELION_DISTANCE),
                0,
                300 * HALF_LONG_AXIS_OF_MOON / APHELION_DISTANCE,
                300 * HALF_SHORT_AXIS_OF_MOON / APHELION_DISTANCE,
                0,
                2 * Math.PI,
                false,
                0
            );
    
            //地球轨道曲线实体
            const earth_orbit_object = createCurveGeometry({
                orbit: earth_orbit,
                color: 'gray',
                position: [0, 0, 0]
            });
    
            //月球轨道曲线实体
            const moon_orbit_object = createCurveGeometry({
                orbit: moon_orbit_2d,
                color: 'gray',
                position: [0, 0, 0]
            });
    
            //旋转月球轨道
            moon_orbit_object.rotateY(MOON_ORBIT_ANGLE / 90 * Math.PI);
    
            scene.add(earth_orbit_object);
            scene.add(moon_orbit_object);
    
            moon_orbit_object.updateMatrixWorld();//更新坐标变换矩阵
            const array = moon_orbit_object.geometry.attributes.position.array;//得到月球轨道坐标
            let moon_orbit_points = [];//月球轨道点集
            for(let i = 0; i < moon_orbit_object.geometry.attributes.position.count; i++){
                let vector = new THREE.Vector3(array[i*3], array[i*3 + 1], array[i*3 + 2]);
                vector.applyMatrix4(moon_orbit_object.matrixWorld);//从局部坐标变换到世界坐标
                moon_orbit_points.push(vector);
            }
            const moon_orbit = new THREE.CatmullRomCurve3(moon_orbit_points);//3d月球轨道
            moon_orbit_object.position.set(300, 0, 0);
    
            const sun_axis = new THREE.Vector3(Math.sin(SUN_ANGLE / 180 * Math.PI), 0,Math.cos(SUN_ANGLE / 180 * Math.PI));//太阳自转轴
            const earth_axis = new THREE.Vector3(Math.sin(EARTH_ANGLE / 180 * Math.PI), 0 ,Math.cos(EARTH_ANGLE / 180 * Math.PI));//地球自转轴
            const moon_axis = new THREE.Vector3(Math.sin(MOON_ANGLE / 180 * Math.PI), 0,Math.cos(MOON_ANGLE / 180 * Math.PI));//月球自转轴
    
            //更新
            let require_id_animate;

            let current_time = 0;
            let stopped_time = 0;

            //更新动画
            const animate = function () {
                let time = Math.floor(performance.now());
                time = time / 1000;
                current_time = time;
                let t_earth_orbit = (time - stopped_time) % EARTH_ORBIT_TIME / EARTH_ORBIT_TIME;
                let t_moon_orbit = (time - stopped_time) % MOON_ORBIT_TIME / MOON_ORBIT_TIME;
                let earth_position_2d = earth_orbit.getPointAt(t_earth_orbit);
                let earth_position = new THREE.Vector3(earth_position_2d.x, earth_position_2d.y, 0);
                earth.position.copy(earth_position);//更新地球坐标
                moon_orbit_object.position.copy(earth_position);//更新月球轨道坐标
                moon.position.addVectors(earth_position, moon_orbit.getPointAt(t_moon_orbit));//更新月球坐标
                sun.setRotationFromAxisAngle(sun_axis, 2*Math.PI *((time - stopped_time) % SUN_TIME) / SUN_TIME);//更新太阳自转角度
                earth.setRotationFromAxisAngle(earth_axis, 2*Math.PI *((time - stopped_time) % EARTH_TIME) / EARTH_TIME);//更新地球自转角度
                moon.setRotationFromAxisAngle(moon_axis, 2*Math.PI *((time - stopped_time) % MOON_TIME) / MOON_TIME);//更新月球自转角度
                camera_at_sun.position.copy(earth_position);//更新相机坐标
                camera_at_sun.lookAt(sun.position);
                camera_at_moon.position.copy(earth_position);//更新相机坐标
                camera_at_moon.lookAt(moon.position);
                require_id_animate = requestAnimationFrame(animate);
            };
            animate();

            //更新渲染器
            const update_renderer = function () {
                renderer.clear();
                renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
                renderer.render(scene, main_camera);
                renderer.setViewport(0, 30, 320, 180);
                renderer.render(scene, camera_at_sun);
                renderer.setViewport(0, 220, 320, 180);
                renderer.render(scene, camera_at_moon);
                requestAnimationFrame(update_renderer);
            };
            update_renderer();

            let require_id_time
            
            //计算暂停时间
            const figure_stopped_time = function () {
                let time = Math.floor(performance.now());
                time = time / 1000;
                stopped_time += time - current_time;
                current_time = time;
                require_id_time = requestAnimationFrame(figure_stopped_time);
            };

            let stopped = false;

            //暂停和播放功能
            const element = document.body;
            element.onkeypress = press;
            function press(event){
                if(event.keyCode == 32){
                    if(stopped){
                        animate();
                        cancelAnimationFrame(require_id_time);
                        stopped = false;
                    }
                    else{
                        cancelAnimationFrame(require_id_animate);
                        figure_stopped_time();
                        stopped = true;
                    }
                }
            }
    
            //初始化视图
            orbitControls.enabled = false;
    
            const select_view_method_element = document.querySelector('#view_method');
            
            //添加视图选择监听
            select_view_method_element.addEventListener('change', (event) => {
                if(event.target.value == 'front_view'){
                    main_camera.position.set(0, 0, 1200);
                    main_camera.lookAt(new THREE.Vector3(0, 0, 0));
                    orbitControls.enabled = false;
                }
                else if(event.target.value == 'side_view'){
                    main_camera.position.set(0, 1200, 0);
                    main_camera.lookAt(new THREE.Vector3(0, 0, 0));
                    orbitControls.enabled = false;
                }
                else{
                    orbitControls.enabled = true;
                }
            })

            const select_earth_skin_element = document.querySelector('#earth_skin');

            //添加换肤选择监听
            select_earth_skin_element.addEventListener('change', (event) => {
                if(event.target.value == 'satellit_imagery'){
                    earth.material.copy(earth_material);
                }
                else{
                    earth.material.copy(earth_map_material);
                }
            });


            //自适应窗口大小
            window.onresize = function(){
                renderer.setSize(window.innerWidth, window.innerHeight);
                main_camera.aspect = window.innerWidth / window.innerHeight;
                main_camera.updateProjectionMatrix();
            }
    
        </script>
    </div>
    
</body>

</html>
